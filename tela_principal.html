<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Welcome to the Innovation Hub</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script id="tailwind-config">tailwind.config = {darkMode: "class", theme: {extend: {colors: {primary: "#39E079", secondary: "#7f00ff", "background-dark": "#122017", accent: "#ff00ff", "text-muted": "#8888a0", "text-light": "#e0e0ff", "background-light": "#f6f8f7"}, fontFamily: {display: "Inter"}, borderRadius: {DEFAULT: "0.5rem", lg: "1rem", xl: "1.5rem", full: "9999px"}, boxShadow: {"glow-primary": "0 0 15px #00f0ff, 0 0 25px #00f0ff, 0 0 35px #00f0ff", "glow-secondary": "0 0 15px #7f00ff, 0 0 25px #7f00ff, 0 0 35px #7f00ff"}, keyframes: {"scan-line": {"0%, 100%": {transform: "translateY(-150%)", opacity: "0"}, "50%": {transform: "translateY(0%)", opacity: "1"}, "80%": {opacity: "0.7"}, "90%": {opacity: "0.3"}}, "holographic-pulse": {"0%": {boxShadow: "0 0 10px #00f0ff, 0 0 20px #00f0ff, inset 0 0 10px #00f0ff"}, "50%": {boxShadow: "0 0 20px #7f00ff, 0 0 40px #7f00ff, inset 0 0 20px #7f00ff"}, "100%": {boxShadow: "0 0 10px #00f0ff, 0 0 20px #00f0ff, inset 0 0 10px #00f0ff"}}}, animation: {scan: "scan-line 3s ease-in-out infinite", "holographic-pulse": "holographic-pulse 3s infinite alternate"}}}};</script>
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 48
        }
        .gradient-text {
            background-image: linear-gradient(90deg, #00f0ff, #7f00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
        
        @keyframes scanLine {
            0% {
                transform: translateY(0px);
                opacity: 1;
            }
            50% {
                transform: translateY(288px);
                opacity: 1;
            }
            100% {
                transform: translateY(0px);
                opacity: 1;
            }
        }
        
        .scan-line-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #39E079;
            box-shadow: 0 0 10px #39E079, 0 0 20px #39E079;
            animation: scanLine 2s linear infinite;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-background-dark text-text-light font-display">
<div class="flex flex-col items-center justify-center min-h-screen p-4">
<div class="w-full max-w-md text-center">
<div class="mb-8">
<span class="material-symbols-outlined text-primary" style="font-size: 100px;">
                qr_code_scanner
            </span>
</div>
<h1 class="text-4xl font-bold mb-4 text-transparent gradient-text">Interface de Escaneamento Avan√ßada</h1>
<p class="text-lg text-text-muted mb-12">Aproxime seu dispositivo de identifica√ß√£o para acesso autorizadp ao hub de inova√ß√£o.</p>
<div class="relative w-72 h-72 mx-auto rounded-xl shadow-glow-primary animate-holographic-pulse border border-primary/30 overflow-hidden">
<video id="webcamVideo" class="w-full h-full object-cover rounded-xl" autoplay muted playsinline></video>
<div class="absolute inset-0 pointer-events-none scan-line-overlay"></div>
<div class="absolute inset-0 border-2 border-secondary/50 rounded-xl pointer-events-none"></div>

<!-- √Årea de detec√ß√£o otimizada -->
<div class="absolute inset-0 pointer-events-none">
<div class="absolute top-1/4 left-1/4 right-1/4 bottom-1/4 border-2 border-primary/60 rounded-lg">
<div class="absolute -top-1 -left-1 w-6 h-6 border-l-2 border-t-2 border-primary"></div>
<div class="absolute -top-1 -right-1 w-6 h-6 border-r-2 border-t-2 border-primary"></div>
<div class="absolute -bottom-1 -left-1 w-6 h-6 border-l-2 border-b-2 border-primary"></div>
<div class="absolute -bottom-1 -right-1 w-6 h-6 border-r-2 border-b-2 border-primary"></div>
</div>
</div>

<!-- Indicador de qualidade -->
<div id="qualityIndicator" class="absolute top-2 right-2 bg-black/50 text-white px-2 py-1 rounded text-xs hidden">
<span id="qualityText">Detectando...</span>
</div>

<div id="errorMessage" class="absolute inset-0 flex items-center justify-center bg-background-dark/80 rounded-xl hidden">
<div class="text-center p-4">
<span class="material-symbols-outlined text-red-400 mb-2" style="font-size: 48px;">videocam_off</span>
<p class="text-red-400 text-sm">Webcam n√£o dispon√≠vel</p>
</div>
</div>
</div>
<p class="text-sm text-text-muted mt-12">Problemas de acesso? Contate o suporte t√©cnico hologr√°fico.</p>
<div class="mt-4 p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg">
<p class="text-xs text-blue-300">üí° <strong>Dica:</strong> Para evitar pedidos repetidos de permiss√£o, clique no √≠cone de c√¢mera na barra de endere√ßos e selecione "Sempre permitir" para este site.</p>
</div>
<div class="mt-2 p-2 bg-green-500/10 border border-green-500/20 rounded-lg">
<p class="text-xs text-green-300">‚å®Ô∏è <strong>Atalho:</strong> Pressione <kbd class="px-1 py-0.5 bg-gray-700 rounded text-xs">Ctrl + .</kbd> para abrir a tela de cadastro</p>
</div>
</div>
</div>
</body>
<script>
// Configura√ß√£o do Supabase
const supabaseUrl = 'https://cretuodvidcfqwgpnauz.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyZXR1b2R2aWRjZnF3Z3BuYXV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MTA5MDIsImV4cCI6MjA3Mzk4NjkwMn0.6WxPs27ox3DAOC2HiW0QTQl4AXxNNlNsWjKlB0NdVQY';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Vari√°veis globais
let isScanning = false;
let scanTimeout = null;
let currentStream = null;

// Fun√ß√£o para inicializar a webcam
async function initWebcam() {
    const video = document.getElementById('webcamVideo');
    const errorMessage = document.getElementById('errorMessage');
    
    // Se j√° temos um stream ativo, reutilizar
    if (currentStream && currentStream.active) {
        video.srcObject = currentStream;
        video.play();
        setTimeout(() => {
            initBarcodeScanner();
        }, 500);
        return;
    }
    
    try {
        // Solicita acesso √† webcam
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: 'environment' // C√¢mera traseira para melhor escaneamento
            } 
        });
        
        // Salvar stream globalmente
        currentStream = stream;
        
        // Conecta o stream ao elemento video
        video.srcObject = stream;
        
        // Garante que o v√≠deo seja reproduzido
        video.onloadedmetadata = () => {
            video.play();
            // Iniciar scanner ap√≥s a webcam estar pronta
            setTimeout(() => {
                initBarcodeScanner();
            }, 1000);
        };
        
    } catch (error) {
        console.error('Erro ao acessar a webcam:', error);
        
        // Exibe mensagem de erro
        errorMessage.classList.remove('hidden');
        video.style.display = 'none';
        
        // Diferentes tipos de erro
        if (error.name === 'NotAllowedError') {
            errorMessage.querySelector('p').textContent = 'Acesso √† webcam negado - Clique em "Permitir" para continuar';
        } else if (error.name === 'NotFoundError') {
            errorMessage.querySelector('p').textContent = 'Webcam n√£o encontrada';
        } else {
            errorMessage.querySelector('p').textContent = 'Erro ao acessar webcam';
        }
    }
}

// Inicializar scanner de c√≥digo de barras
function initBarcodeScanner() {
    if (isScanning) return;
    
    isScanning = true;
    
    // Configura√ß√£o otimizada do QuaggaJS para m√°xima precis√£o
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#webcamVideo'),
            constraints: {
                width: { min: 640, ideal: 1280, max: 1920 },
                height: { min: 480, ideal: 720, max: 1080 },
                facingMode: "environment",
                frameRate: { ideal: 30, max: 60 }
            },
            area: { // √Årea de detec√ß√£o otimizada
                top: "20%",
                right: "10%",
                left: "10%",
                bottom: "20%"
            }
        },
        decoder: {
            readers: [
                "code_128_reader",
                "ean_reader",
                "ean_8_reader",
                "code_39_reader",
                "codabar_reader",
                "upc_reader",
                "upc_e_reader",
                "i2of5_reader"
            ],
            debug: {
                drawBoundingBox: true,
                showFrequency: true,
                drawScanline: true,
                showPatch: true
            },
            multiple: false // Detectar apenas um c√≥digo por vez
        },
        locate: true,
        locator: {
            patchSize: "large", // √Årea maior para detec√ß√£o
            halfSample: false, // Usar resolu√ß√£o completa
            showCanvas: true,
            showPatches: true,
            showFoundPatches: true,
            showSkeleton: true,
            showLabels: true,
            showPatchLabels: true,
            showBoundingBox: true,
            boxFromPatches: {
                showTransformed: true,
                showTransformedBox: true,
                showBB: true
            }
        },
        numOfWorkers: 4, // Usar m√∫ltiplos workers para processamento
        frequency: 10, // Verificar 10 vezes por segundo
        debug: false,
        locate: true
    }, function(err) {
        if (err) {
            console.error('Erro ao inicializar scanner:', err);
            return;
        }
        Quagga.start();
    });

    // Mostrar indicador de qualidade
    mostrarIndicadorQualidade();
    
    // Detectar c√≥digo de barras com valida√ß√£o aprimorada
    Quagga.onDetected(function(result) {
        if (result && result.codeResult) {
            const code = result.codeResult.code;
            const confidence = result.codeResult.decodedCodes[0].error;
            
            console.log('C√≥digo detectado:', code, 'Confian√ßa:', confidence);
            
            // Validar confian√ßa m√≠nima (quanto menor o erro, melhor)
            if (confidence < 0.1) { // 90% de confian√ßa
                // Parar o scanner temporariamente
                Quagga.stop();
                isScanning = false;
                
                // Buscar usu√°rio no banco de dados
                buscarUsuario(code);
            } else {
                console.log('C√≥digo detectado mas com baixa confian√ßa, continuando scan...');
                atualizarIndicadorQualidade(`Baixa confian√ßa: ${Math.round((1-confidence)*100)}%`);
            }
        }
    });
    
    // Monitorar qualidade da detec√ß√£o
    Quagga.onProcessed(function(result) {
        if (result) {
            const drawingCtx = Quagga.canvas.ctx.overlay;
            const drawingCanvas = Quagga.canvas.dom.overlay;
            
            if (result.codeResult) {
                atualizarIndicadorQualidade('C√≥digo detectado!');
            } else {
                atualizarIndicadorQualidade('Aguardando c√≥digo...');
            }
        }
    });
}

// Buscar usu√°rio por c√≥digo de barras
async function buscarUsuario(codigoBarras) {
    try {
        // Ocultar indicador de qualidade
        ocultarIndicadorQualidade();
        
        // Mostrar feedback visual
        mostrarFeedback('Verificando acesso...', 'info');
        
        const { data, error } = await supabase
            .from('usuarios')
            .select('nome_completo, empresa')
            .eq('codigo_barras', codigoBarras)
            .single();
        
        if (error) {
            if (error.code === 'PGRST116') {
                // Usu√°rio n√£o encontrado
                mostrarFeedback('Acesso negado - Usu√°rio n√£o cadastrado', 'error');
                setTimeout(() => {
                    reiniciarScanner();
                }, 3000);
            } else {
                throw error;
            }
        } else {
            // Usu√°rio encontrado - redirecionar
            mostrarFeedback('Acesso autorizado!', 'success');
            setTimeout(() => {
                redirecionarParaBemVindo(data.nome_completo);
            }, 1500);
        }
        
    } catch (error) {
        console.error('Erro ao buscar usu√°rio:', error);
        mostrarFeedback('Erro ao verificar acesso', 'error');
        setTimeout(() => {
            reiniciarScanner();
        }, 3000);
    }
}

// Mostrar feedback visual
function mostrarFeedback(mensagem, tipo) {
    // Remover feedback anterior se existir
    const feedbackExistente = document.getElementById('feedback-message');
    if (feedbackExistente) {
        feedbackExistente.remove();
    }
    
    const feedback = document.createElement('div');
    feedback.id = 'feedback-message';
    feedback.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg text-white font-semibold z-50 ${
        tipo === 'success' ? 'bg-green-500' : 
        tipo === 'error' ? 'bg-red-500' : 
        'bg-blue-500'
    }`;
    feedback.textContent = mensagem;
    
    document.body.appendChild(feedback);
    
    // Remover ap√≥s 3 segundos
    setTimeout(() => {
        if (feedback.parentNode) {
            feedback.remove();
        }
    }, 3000);
}

// Redirecionar para tela de boas-vindas
function redirecionarParaBemVindo(nomeCompleto) {
    // Extrair primeiro nome
    const primeiroNome = nomeCompleto.split(' ')[0];
    
    // Salvar nome no localStorage para a pr√≥xima tela
    localStorage.setItem('usuarioNome', primeiroNome);
    
    // Redirecionar
    window.location.href = 'tela_depois_cracha.html';
}

// Reiniciar scanner
function reiniciarScanner() {
    if (isScanning) return;
    
    setTimeout(() => {
        initBarcodeScanner();
    }, 1000);
}

// Fun√ß√£o para limpar stream quando necess√°rio
function limparStream() {
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
    }
}

// Fun√ß√£o para reinicializar c√¢mera se necess√°rio
function reinicializarCamera() {
    limparStream();
    setTimeout(() => {
        initWebcam();
    }, 500);
}

// Mostrar indicador de qualidade
function mostrarIndicadorQualidade() {
    const indicator = document.getElementById('qualityIndicator');
    if (indicator) {
        indicator.classList.remove('hidden');
    }
}

// Atualizar indicador de qualidade
function atualizarIndicadorQualidade(texto) {
    const qualityText = document.getElementById('qualityText');
    if (qualityText) {
        qualityText.textContent = texto;
    }
}

// Ocultar indicador de qualidade
function ocultarIndicadorQualidade() {
    const indicator = document.getElementById('qualityIndicator');
    if (indicator) {
        indicator.classList.add('hidden');
    }
}

// Inicializa a webcam quando a p√°gina carrega
document.addEventListener('DOMContentLoaded', initWebcam);

// Limpa o stream quando a p√°gina √© fechada
window.addEventListener('beforeunload', () => {
    limparStream();
    
    if (isScanning) {
        Quagga.stop();
    }
});

// Adicionar bot√£o para reinicializar c√¢mera se necess√°rio
document.addEventListener('DOMContentLoaded', () => {
    // Adicionar bot√£o de reinicializar c√¢mera
    const buttonContainer = document.querySelector('.w-full.max-w-md.text-center');
    const reiniciarBtn = document.createElement('button');
    reiniciarBtn.className = 'mt-4 px-4 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/80 transition-colors text-sm';
    reiniciarBtn.innerHTML = '<span class="material-symbols-outlined text-sm mr-2">refresh</span>Reiniciar C√¢mera';
    reiniciarBtn.onclick = reinicializarCamera;
    buttonContainer.appendChild(reiniciarBtn);
    
    // Adicionar bot√£o de cadastro
    const cadastroBtn = document.createElement('button');
    cadastroBtn.className = 'mt-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/80 transition-colors text-sm';
    cadastroBtn.innerHTML = '<span class="material-symbols-outlined text-sm mr-2">person_add</span>Cadastrar Usu√°rio';
    cadastroBtn.onclick = () => window.location.href = 'tela_cadastro.html';
    buttonContainer.appendChild(cadastroBtn);
});

// Adicionar atalho de teclado Ctrl + . para abrir cadastro
document.addEventListener('keydown', (event) => {
    // Verificar se Ctrl + . foi pressionado
    if (event.ctrlKey && event.key === '.') {
        event.preventDefault(); // Prevenir comportamento padr√£o
        window.location.href = 'tela_cadastro.html';
    }
});
</script>
</html>