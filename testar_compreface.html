<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testar CompreFace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto">
            <h1 class="text-4xl font-bold mb-8 text-center">üß™ Testar CompreFace</h1>
            
            <!-- Status da Conex√£o -->
            <div id="connectionStatus" class="mb-6 p-4 rounded-lg bg-gray-800">
                <div class="flex items-center">
                    <span class="material-icons mr-2">sync</span>
                    <span>Testando conex√£o...</span>
                </div>
            </div>

            <!-- Configura√ß√µes -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">‚öôÔ∏è Configura√ß√µes</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">URL do CompreFace</label>
                        <input type="text" id="comprefaceUrl" 
                               value="http://localhost:8000/api/v1"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">API Key</label>
                        <input type="text" id="apiKey" 
                               value="c3e84a46-1a08-4913-8330-31818f0c0e06"
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <button onclick="testarConexao()" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        <span class="material-icons mr-2">wifi</span>
                        Testar Conex√£o
                    </button>
                </div>
            </div>

            <!-- Testes -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">üß™ Testes Dispon√≠veis</h2>
                
                <div class="space-y-3">
                    <button onclick="testarStatus()" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        <span class="material-icons mr-2">check_circle</span>
                        Testar Status da API
                    </button>
                    
                    <button onclick="testarDetecao()" 
                            class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        <span class="material-icons mr-2">face</span>
                        Testar Detec√ß√£o de Faces
                    </button>
                    
                    <button onclick="testarReconhecimento()" 
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        <span class="material-icons mr-2">person_search</span>
                        Testar Reconhecimento
                    </button>
                    
                    <button onclick="listarUsuarios()" 
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        <span class="material-icons mr-2">people</span>
                        Listar Usu√°rios Cadastrados
                    </button>
                </div>
            </div>

            <!-- Logs -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <span class="material-icons mr-2">terminal</span>
                    Logs dos Testes
                </h3>
                <div id="logs" class="bg-black rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm">
                    <div class="text-green-400">Sistema de teste iniciado...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class CompreFaceTester {
            constructor() {
                this.baseUrl = 'http://localhost:8000/api/v1';
                this.apiKey = 'c3e84a46-1a08-4913-8330-31818f0c0e06';
            }

            updateConnectionStatus(type, message) {
                const status = document.getElementById('connectionStatus');
                const icon = status.querySelector('.material-icons');
                const text = status.querySelector('span:last-child');
                
                status.className = `mb-6 p-4 rounded-lg ${type === 'success' ? 'bg-green-800' : type === 'error' ? 'bg-red-800' : 'bg-yellow-800'}`;
                icon.textContent = type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'warning';
                text.textContent = message;
            }

            log(message, type = 'info') {
                const logs = document.getElementById('logs');
                const timestamp = new Date().toLocaleTimeString();
                const color = type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-400' : type === 'warning' ? 'text-yellow-400' : 'text-gray-400';
                logs.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
                logs.scrollTop = logs.scrollHeight;
            }

            async testarConexao() {
                this.baseUrl = document.getElementById('comprefaceUrl').value;
                this.apiKey = document.getElementById('apiKey').value;
                
                this.log('üîç Testando conex√£o com CompreFace...');
                this.updateConnectionStatus('warning', 'Testando conex√£o...');
                
                try {
                    // CompreFace n√£o tem endpoint /status, vamos testar com /faces
                    const response = await fetch(`${this.baseUrl}/faces`, {
                        method: 'GET',
                        headers: {
                            'x-api-key': this.apiKey
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.log('‚úÖ Conex√£o estabelecida com sucesso!', 'success');
                        this.log(`üìä Usu√°rios cadastrados: ${data.length}`, 'success');
                        this.updateConnectionStatus('success', '‚úÖ Conectado ao CompreFace');
                    } else if (response.status === 400) {
                        // Erro 400 √© normal se n√£o houver usu√°rios cadastrados
                        this.log('‚úÖ Conex√£o estabelecida! (sem usu√°rios cadastrados)', 'success');
                        this.updateConnectionStatus('success', '‚úÖ Conectado ao CompreFace');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    this.log(`‚ùå Erro de conex√£o: ${error.message}`, 'error');
                    this.updateConnectionStatus('error', `‚ùå Erro: ${error.message}`);
                }
            }

            async testarStatus() {
                this.log('üìä Testando status da API...');
                
                try {
                    // CompreFace n√£o tem endpoint /status, vamos testar com /faces
                    const response = await fetch(`${this.baseUrl}/faces`, {
                        method: 'GET',
                        headers: {
                            'x-api-key': this.apiKey
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.log('‚úÖ API funcionando!', 'success');
                        this.log(`üìã Usu√°rios cadastrados: ${data.length}`, 'success');
                    } else if (response.status === 400) {
                        this.log('‚úÖ API funcionando! (sem usu√°rios cadastrados)', 'success');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    this.log(`‚ùå Erro ao testar API: ${error.message}`, 'error');
                }
            }

            async testarDetecao() {
                this.log('üë§ Testando detec√ß√£o de faces...');
                
                // Criar uma imagem de teste simples
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                
                // Desenhar um rosto simples
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, 200, 200);
                
                // Cabe√ßa
                ctx.fillStyle = '#ffdbac';
                ctx.beginPath();
                ctx.arc(100, 100, 80, 0, 2 * Math.PI);
                ctx.fill();
                
                // Olhos
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(80, 80, 10, 0, 2 * Math.PI);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(120, 80, 10, 0, 2 * Math.PI);
                ctx.fill();
                
                // Nariz
                ctx.fillStyle = '#ffdbac';
                ctx.beginPath();
                ctx.arc(100, 100, 5, 0, 2 * Math.PI);
                ctx.fill();
                
                // Boca
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(100, 120, 20, 0, Math.PI);
                ctx.stroke();
                
                try {
                    const imageData = canvas.toDataURL('image/jpeg', 0.8);
                    const base64Data = imageData.split(',')[1];
                    
                    const response = await fetch(`${this.baseUrl}/faces/detect`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': this.apiKey
                        },
                        body: JSON.stringify({
                            file: base64Data
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.log('‚úÖ Detec√ß√£o de faces funcionando!', 'success');
                        this.log(`üìã Resultado: ${JSON.stringify(data, null, 2)}`, 'success');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    this.log(`‚ùå Erro na detec√ß√£o: ${error.message}`, 'error');
                }
            }

            async testarReconhecimento() {
                this.log('üîç Testando reconhecimento facial...');
                
                try {
                    const response = await fetch(`${this.baseUrl}/faces/recognize`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': this.apiKey
                        },
                        body: JSON.stringify({
                            file: 'dummy_base64_data'
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.log('‚úÖ Reconhecimento funcionando!', 'success');
                        this.log(`üìã Resultado: ${JSON.stringify(data, null, 2)}`, 'success');
                    } else {
                        this.log(`‚ö†Ô∏è Reconhecimento retornou: ${response.status}`, 'warning');
                        this.log('üí° Isso √© normal se n√£o houver usu√°rios cadastrados', 'info');
                    }
                } catch (error) {
                    this.log(`‚ùå Erro no reconhecimento: ${error.message}`, 'error');
                }
            }

            async listarUsuarios() {
                this.log('üë• Listando usu√°rios cadastrados...');
                
                try {
                    const response = await fetch(`${this.baseUrl}/faces`, {
                        method: 'GET',
                        headers: {
                            'x-api-key': this.apiKey
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.log('‚úÖ Lista de usu√°rios obtida!', 'success');
                        this.log(`üìã Usu√°rios: ${JSON.stringify(data, null, 2)}`, 'success');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    this.log(`‚ùå Erro ao listar usu√°rios: ${error.message}`, 'error');
                }
            }
        }

        // Instanciar o testador
        const tester = new CompreFaceTester();

        // Fun√ß√µes globais
        function testarConexao() { tester.testarConexao(); }
        function testarStatus() { tester.testarStatus(); }
        function testarDetecao() { tester.testarDetecao(); }
        function testarReconhecimento() { tester.testarReconhecimento(); }
        function listarUsuarios() { tester.listarUsuarios(); }

        // Testar conex√£o automaticamente ao carregar
        document.addEventListener('DOMContentLoaded', () => {
            tester.testarConexao();
        });
    </script>
</body>
</html>
